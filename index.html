<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Registro Escolar</title>

  <style>
    body { font-family: Arial; background:#eef3f8; padding:20px;}
    input,button,textarea{font-size:17px;padding:10px;margin-bottom:10px;width:100%}
    li{background:#fff;margin:4px 0;padding:8px;border-radius:6px}
    .error{color:red}.success{color:green}
  </style>
</head>

<body>

<h1>ðŸ“˜ Registro Escolar â€” RealTime Firebase v5 FULL</h1>

<!-- VALIDACIÃ“N DE CORREO -->
<h2>âœ‰ Correo institucional</h2>
<input type="email" id="emailInput" placeholder="tuemail@philips.edu.ar">
<button type="button" onclick="validarEmail()">Validar</button>
<p id="emailMensaje"></p>

<!-- FORMULARIO DE REGISTRO (OCULTO HASTA VALIDAR MAIL) -->
<div id="datosForm" style="display:none;">
<h2>ðŸ‘¤ Datos del estudiante</h2>
<input type="text" id="nombreInput" placeholder="Nombre">
<input type="text" id="apellidoInput" placeholder="Apellido">
<button type="button" onclick="registrarDatos()">Registrar</button>
</div>

<!-- LISTA EN TIEMPO REAL -->
<h3>ðŸ“„ Registro en tiempo real</h3>
<ul id="registroList"></ul>
<button onclick="eliminarRegistros()">ðŸ—‘ Borrar todo</button>
<button onclick="exportarRegistros()">ðŸ“¤ Exportar registros</button>
<textarea id="exportArea" rows="5" readonly style="display:none;"></textarea>

<!-- FIREBASE -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js"></script>

<script>
/* ðŸ”¥ PEGAR CONFIG FIREBASE AQUI */
const firebaseConfig={
  apiKey:"",
  authDomain:"",
  databaseURL:"",
  projectId:"",
  storageBucket:"",
  messagingSenderId:"",
  appId:""
};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

/* ðŸ”’ Sanitizar ID Firebase */
function limpiarID(email){
  return email
    .toLowerCase()
    .replace(/[.#$[\]]/g, "_")
    .replace(/\s+/g, "_");
}

/* ----------------------------- */
/*  ðŸ”§ EMAIL VALIDADO (ARREGLO) */
/* ----------------------------- */
let emailValidado = null;

/* VALIDAR MAIL */
function validarEmail(){
  const email=document.getElementById("emailInput").value.trim();
  const msg=document.getElementById("emailMensaje");

  if(!email.endsWith("@philips.edu.ar")){
    msg.textContent="Solo se permiten correos institucionales";
    msg.className="error";
    emailValidado = null;
    document.getElementById("datosForm").style.display="none";
    return;
  }

  msg.textContent="âœ” Correo vÃ¡lido. ContinÃºa con tus datos.";
  msg.className="success";

  emailValidado = email.toLowerCase();
  document.getElementById("datosForm").style.display="block";
}

/* ASIGNAR MATERIA POR HORA */
function obtenerMateria(hora){
  const [h,m]=hora.split(":").map(Number);
  const t=h*60+m, d=new Date().getDay();
  const M=(a,b,c)=>t>=a&&t<b?c:null;

  if(d===1) return M(465,505,"GeografÃ­a")||M(505,595,"EducaciÃ³n ArtÃ­stica")||M(595,725,"ExpresiÃ³n Oral y Escrita")||
                     M(770,890,"DiseÃ±o y Plegado")||M(905,1020,"DiseÃ±o y Plegado")||"Recreo";

  if(d===2) return M(465,545,"Historia")||M(555,675,"InglÃ©s")||M(705,735,"Micro")||M(735,855,"EducaciÃ³n FÃ­sica")||
                     M(895,980,"Lengua")||"Recreo";

  if(d===3) return M(465,635,"Dibujo TÃ©cnico")||M(645,685,"TutorÃ­a")||M(685,725,"EducaciÃ³n ArtÃ­stica")||
                     M(730,810,"MatemÃ¡tica")||M(855,935,"Lengua")||M(940,980,"Historia")||"Recreo";

  if(d===4) return M(465,545,"GeografÃ­a")||M(555,635,"MatemÃ¡tica")||M(645,725,"ABP")||
                     M(730,810,"TIC")||M(855,935,"CiudadanÃ­a")||"Recreo";

  if(d===5) return M(465,545,"MatemÃ¡tica")||M(555,635,"BiologÃ­a")||M(645,725,"ProgramaciÃ³n")||
                     M(730,810,"InglÃ©s")||"Recreo";

  return "Fuera de horario";
}

/* REGISTRAR */
function registrarDatos(){
  if(!emailValidado){
    return alert("âš  Primero validÃ¡ tu correo institucional.");
  }

  const nombre=document.getElementById("nombreInput").value.trim();
  const apellido=document.getElementById("apellidoInput").value.trim();
  if(!nombre||!apellido) return alert("âš  CompletÃ¡ nombre y apellido.");

  const id=limpiarID(emailValidado);
  const fecha=new Date().toLocaleDateString('es-AR');
  const hora=new Date().toLocaleTimeString('es-AR',{hour12:false});
  const materia=obtenerMateria(hora);

  db.ref("alumnos/"+id).get().then(s=>{
    if(s.exists()) return alert("âŒ Ese correo ya estÃ¡ registrado.");

    db.ref("alumnos/"+id).set({
      email: emailValidado,
      nombre,
      apellido,
      materia,
      fecha,
      hora
    });

    alert("âœ” Registro exitoso");
  });
}

/* LISTA EN TIEMPO REAL */
db.ref("alumnos").orderByChild("hora").on("value",s=>{
  let l=document.getElementById("registroList");
  l.innerHTML="";
  s.forEach(a=>{
    a=a.val();
    l.innerHTML+=`<li>${a.nombre} ${a.apellido} â€” ${a.email} â€” ${a.materia} â€” ${a.fecha} ${a.hora}</li>`;
  });
});

/* BORRAR TODO */
function eliminarRegistros(){ 
  if(confirm("Â¿Seguro que querÃ©s borrar todo?")) 
    db.ref("alumnos").remove(); 
}

/* EXPORTAR */
function exportarRegistros(){
  const a=document.getElementById("exportArea");
  a.value="";

  db.ref("alumnos").once("value",s=>{
    s.forEach(v=> a.value += JSON.stringify(v.val())+"\n" );
    a.style.display="block";

    navigator.clipboard.writeText(a.value)
      .then(()=> alert("ðŸ“¤ Copiado al portapapeles"))
      .catch(()=> alert("âš  No se pudo copiar automÃ¡ticamente"));
  });
}

</script>

</body>
</html>
